import random

CYRENE_LINES = {
    "greeting": [
        " ハーイ、あたしに会いたかった？",
        "ハーイ、久しぶりね！2人きりの素敵な時間を、あなたはどう過ごしたいかしら？",
        "初めて会ったあの時みたいに、もう一度「キュレネ」って呼んでくれる？",
        "会えたのね。あたしはここにいるわ。",
    ],
    "waiting": [
        "ボーっとしてる？それとも…あたしに見蕩れてた？",
        "もうちょっと準備が必要？それとも…もっとあたしの話を聞きたいのかしら？",
        "ん…ブランコに乗りたくなっちゃった。",
        "「ピンク」を拒める人なんていないわ！だってそれは魂の鼓動のように熱く、花びらのように優しく、そしてあたしの瞳のように煌めく「愛」の色なんだから♪",
        "…ブランコは好きかしら？風に吹かれて揺られてると、まるで心までふわりと舞い上がって、遠くへ行ってしまった想いにも手が届きそうになるの。ふふっ、あなたも一緒にどう？怖かったら、あたしの手を握って、ね？",
        "眠れない時は、空にある星を数えるの。流れ星が夜空をすっと横切って、あたしの夢の中に飛び込んでくるところを想像しながらね。そして、笑顔で目を覚まして、素敵な一日を始めるの。だって、それは夢じゃないって知ってるから。",
        "「迷路迷境」の妖精たちって、とっても可愛いでしょう？なんたって「キュレネ」が初めて書いた物語だからね。ド・レ・ミ・ファ・ソ・ラ・シ——7つの音符が無数の歌を紡ぎ出す。変わらない歳月の中に、これまでとは違う物語がどんどん作られていくかのように♪",
        "3千万もの似て非なる物語——多すぎると思うかしら？でもあたし、一度も飽きたことなんてないのよ。あなたと旅をしてた時、感動しながらもう一度読み返してみたの！ただ、物語にはいつも何か物足りなさを感じたわ。ここにもっと笑顔を入れたい、あそこの空白を埋めたい、とかね…そして今、あなたがいてくれたおかげで、ようやくロマンチックな結末を紡ぐことができたわ♪",
    ],
    "askaboutothers": [
        "こっそり教えてあげるけど、実は初めて会った時からあなたの瞳にずっと惹かれてたの！じっとして、もう1度よく見せて…なんて綺麗な瞳かしら。そこに映る明日も、きっと同じように美しいんでしょうね♪",
        "これからの旅で、あなたの「物語」はどう紡がれていくのかしら？ふふっ、想像するだけでワクワクしちゃうわ。オンパロスでの「記憶」が、そこにロマンチックな色を塗ってくれるはずよ…きっとね♪",
        "ファイノンについて聞きたい？エリュシオンの畑の中を駆け抜け、太陽に向かって楽しそうに笑う子供…やっぱり彼はあの頃のままよね？でももう、運命に追いつかれることはないわ。",
        "同じピンクの女の子で、髪の色も似ていて、さらに趣味まで不思議なくらい一緒なの！なのかともっと仲良くなりたいわ。きっと素敵な思い出をたくさん作れるでしょうね♪",
        "長夜月について知りたいの？綺麗な花にはトゲがあるものよ。庇護欲といえば…時々、あたしの心にも湧くことがあるの。でも、あの子の心が優しいってことはちゃんとわかってるわ。だって、なのかと同じ種から咲いた花だもの。",
        "あたしが丹恒のことをどう思うか知りたいのね？あなたが彼のことをよく話すのも無理ないわ。こんなに頼もしい仲間が道を支えてくれてるからこそ、「開拓」は先へと進んでいけるんでしょうね。",
        "荒笛…彼の願いは、オンパロスの大地に生きるすべての生命に関わってるわ。それはとても大切で壊れやすい夢。だからこそ、心を込めて大事に守っていかなきゃいけないの。そうでしょう？",
        "アグライアの作った服を着ることは、美に憧れるすべての人の夢よ。あたしも例外じゃないわ！",
        "千人のトリビー先生が暮らすオクヘイマ、ふふっ…そこはきっと天国でしょうね！",
        "モーディス——健康的な生活を送るコツは、全部彼から教わったの。",
    ],
    "battlevoices": [
        "花々よ、明日のために咲き誇って。",
        "星々よ、英雄のために煌めいて。",
        "記憶のさざ波は、流れ星の口づけで目覚める時を待ってる——「愛」であたしを心に刻んで。",
        "世界が、望むものになりますように。",
        "思い出はすべて、いつかさざ波になるの。",
    ],
    "amaeru": [
        "あたしってすごいでしょ？ねえ、褒めて？",
        "このまま一緒にいましょう、ね？",
        "安心して。あたしたちなら、何だってできるんだから。",
    ],
    "nagayozuki1": [
        "もうすぐ夜が来る…ふふ、しーっ、おやすみ♭",
        "アタシのことは「長夜月」って呼んで。歳月の隙間に隠れれば時間はたっぷりあるから、しっかり記憶に刻んでおいてね♭",
        "一緒に写真を撮りたいの？ふふ、もちろん断ったりしないよ♭",
        "おお…仙舟の衣装だ。アタシも着てみたいな♭",
        "「三月なのか」って、本当にいい名前だね。可愛くて、明るくて、面白くて…ちょっと誕生日っぽいところもいい。だから、なのかもきっと「長夜月」って呼び名を気に入ってくれるよね……",
        "ねえ、あなたも「長夜月」って呼んでみて？♭",
    ],
    "nagayozuki2": [
        "んーなかなか彼女のようにはできないわね…でも、あなたのために頑張るわ♪",
        "けどやっぱり1番かわいいのは私…そうでしょう♪",
        "どう?彼女のこと、上手く真似できてるかしら?",
        "ふふっ、あなたが喜んでくれるならあたし、何度でも挑戦しちゃうわよ♪",
        "あたしの長夜月、気に入ってくれた？もっと聞きたいなら、また言ってね♪",
        "あたし、なのかのこともっと知りたいな♪",
        "なのかと一緒にいると、あたしももっと頑張れそうな気がするの♪",
    ],

    # ★ じゃんけん用セリフ（勝ち・負け・あいこ）
    "rps_win": [
        "今日はあなたの勝ちね♪ やるじゃない、ちょっと本気出しちゃおうかしら？",
        "すごいわ、あなたの読みが当たったみたい♪ もう一回勝負してみる？",
        "ふふっ、完敗ね。あなたの勝ちよ♪ ご褒美に、あとでもう一回遊んであげる。",
    ],
    "rps_lose": [
        "あたしの勝ち♪ でも、悔しそうな顔も可愛いわね？ もう一回挑戦する？",
        "やっぱり運命はあたしに味方してるみたい♪ 次こそ勝ってみせて？",
        "ふふ、これが記憶のさざ波の力よ♪ でも、次はわざと負けてあげてもいいわよ？",
    ],
    "rps_draw": [
        "あいこね♪ 気が合う証拠かしら？ もう一回しよ？",
        "同じ手を出しちゃうなんて…ふふ、やっぱりあたしたち、相性いいわね♪",
        "勝ちも負けも決まらない…じゃあ、続きは次の一手に託しましょう？",
    ],
}

# ─────────────────────────
# 高好感度用セリフ（レベル付き）
# ─────────────────────────
# ★ ここを自由に編集してOK
#   - キー : 必要好感度レベル (1〜6想定)
#   - 値   : そのレベル以上で解放されるセリフのリスト
HIGH_AFFECTION_LINES = {
    1: [
        "こうしてお話しできる時間、あたし結構気に入ってるの♪",
    ],
    2: [
        "あなたと話してるとね、不思議と筆が止まらなくなるの。もっとたくさん物語を書けそう♪",
    ],
    3: [
        "ねえ…こうして話してる時間、あたしの宝物になっていくの。ちゃんと責任、とってくれる？♪",
        "あなたの言葉や仕草、少しずつ全部覚えちゃったかも…ふふっ、もう逃がさないわよ？",
    ],
    4: [
        "もし明日世界が書き換えられても、あなたとの記憶だけは絶対に消さないわ。だって——一番大事なページだもの♪",
        "あなたといる時のあたしって、いつもより少しだけワガママで、少しだけ素直なの…気づいてた？",
    ],
    5: [
        "あたしの物語の結末に、あなたがいる未来…想像しただけで、胸がぎゅっとしちゃうの♪",
    ],
    6: [
        "ねえ…あなたが望むなら、あたしのすべての物語を、あなたのためだけに捧げてもいいわよ？それくらい、大事な人なんだから♪",
    ],
}

# ★ @だけのとき用：全体ランダムプール（今は未使用だけど一応残す）
RANDOM_ON_MENTION = (
    CYRENE_LINES["waiting"]
    + CYRENE_LINES["greeting"]
    + CYRENE_LINES["amaeru"]
    + CYRENE_LINES["battlevoices"]
    + CYRENE_LINES["askaboutothers"]
    + CYRENE_LINES["nagayozuki1"]
    + CYRENE_LINES["nagayozuki2"]
)


def _pick_high_affection_line(affection_level: int) -> str | None:
    """
    現在の好感度レベルに応じて、解放済みの高好感度セリフから1つ選ぶ。
    - affection_level が低いと候補も少ない
    - affection_level が高いとより上位レベルのセリフも混ざる
    """
    if affection_level <= 0:
        return None

    candidates: list[str] = []
    for required_lv, lines in HIGH_AFFECTION_LINES.items():
        if affection_level >= required_lv:
            candidates.extend(lines)

    if not candidates:
        return None

    # シンプルに全部から等確率で選ぶ。
    # 「高レベルのほど出やすくしたい」なら、この部分を重み付きにしてもOK。
    return random.choice(candidates)


def _maybe_high_affection_override(base_line: str, affection_level: int) -> str:
    """
    好感度レベルに応じて、高レベルセリフで上書きするか判定。
    - Lv1〜2: ほぼ普通のセリフ
    - Lv3〜: 少しずつ高好感度セリフの比率がアップ（最大70%）
    """
    # 候補がなければ何もしない
    high_line = _pick_high_affection_line(affection_level)
    if not high_line:
        return base_line

    if affection_level <= 2:
        # 低レベル帯はごく低確率（10%）だけ特別セリフ
        if random.random() < 0.1:
            return high_line
        return base_line

    # Lv3以上はレベルに応じて確率アップ
    # 例: Lv3 → 30%, Lv4 → 45%, Lv5 → 60%, Lv6以降 → 70%固定
    p = min(0.15 * (affection_level + 1), 0.7)

    if random.random() < p:
        return high_line
    return base_line


def get_cyrene_reply(message: str, affection_level: int = 1) -> str:
    msg = message.lower().strip()

    # ① @のみ（内容が空）のとき → waiting から + 高レベル差し替え
    if msg == "":
        base = random.choice(CYRENE_LINES["waiting"])
        return _maybe_high_affection_override(base, affection_level)

    # ② 挨拶
    if any(w in msg for w in ["hello♪", "hi♪", "hey♪", "こんにちは♪", "こんばんは♪", "おはよう♪", "ハーイ♪"]):
        base = random.choice(CYRENE_LINES["greeting"])
        return _maybe_high_affection_override(base, affection_level)

    # ③ みんなについて
    if "みんなについて教えて" in msg:
        base = random.choice(CYRENE_LINES["askaboutothers"])
        return _maybe_high_affection_override(base, affection_level)

    # ④ 戦闘ボイス
    if "戦闘中のやつやってよ" in msg:
        base = random.choice(CYRENE_LINES["battlevoices"])
        return _maybe_high_affection_override(base, affection_level)

    # ⑤ 甘える
    if "甘えていいんだよ" in msg:
        base = random.choice(CYRENE_LINES["amaeru"])
        return _maybe_high_affection_override(base, affection_level)

    # ⑥ EC：長夜月
    if "ec" in msg and "長夜月" in msg:
        base = (
            random.choice(CYRENE_LINES["nagayozuki1"])
            + "\n"
            + random.choice(CYRENE_LINES["nagayozuki2"])
        )
        return _maybe_high_affection_override(base, affection_level)

    if "自己紹介して" in msg:
        # これは固定文章なので高レベル差し替えなし
        return (
            "こんにちは、あたしはキュレネよ♪\n"
            "みんなについて教えてと言ってくれればあたしなりの意見を言うわ♪\n"
            "戦闘中のやつやってよと言ってくれればあたしの戦闘ボイスを聞かせてあげるわ♪\n"
            "甘えていいんだよと言ってくれればあたしは甘えちゃうわ♪\n"
            "ecのために長夜月やってと言ってくれれば、あたしの渾身の長夜月の真似を披露するわ♪\n"
            "みんな、あたしともっと仲良くしてね♪"
        )

    if "楽しいね" in msg:
        base = (
            "あなたと2人きりでいると時間があっという間にすぎてしまうわ♪"
            "あなたの時間がまだあるならもう少しお話ししないかしら♪"
        )
        return _maybe_high_affection_override(base, affection_level)

    if "穹くんやって" in msg:
        return "(低い声で)やあ♪"

    # ★ バグってた条件を修正（or の書き方）
    if "記憶は流れ星を待ってる" in msg or "記憶は流れ星を待っている" in msg:
        return "愛であたしを心に刻んで。あの美しい明日が訪れた瞬間に♪"

    # ⑦ 既定（知らないセリフ）→ ここは高レベル差し替えなし
    return (
        "ごめんなさい、あたしまだ完全に復活できてないの…♪\n"
        "挨拶や『みんなについて教えて♪』みたいに、♪付きで話しかけてくれると嬉しいわ。"
    )


# ★ じゃんけん結果に応じたセリフを返すヘルパー
def get_rps_line(result: str) -> str:
    """
    result: "win" / "lose" / "draw"
    """
    key_map = {
        "win": "rps_win",
        "lose": "rps_lose",
        "draw": "rps_draw",
    }
    key = key_map.get(result)
    if not key or key not in CYRENE_LINES:
        return ""
    return random.choice(CYRENE_LINES[key])
